# Fluentd configuration for go-demo log collection

# HTTP input for health checks
<source>
  @type http
  port 9880
  bind 0.0.0.0
</source>

# Forward input from application containers
<source>
  @type forward
  port 24224
  bind 0.0.0.0
</source>

# Parse JSON logs from go-demo application
<filter go-demo.**>
  @type parser
  key_name log
  reserve_data true
  remove_key_name_field true
  emit_invalid_record_to_error false
  <parse>
    @type json
    time_key @timestamp
    time_format %Y-%m-%dT%H:%M:%S.%L%z
  </parse>
</filter>

# Add additional metadata to logs
<filter go-demo.**>
  @type record_transformer
  <record>
    hostname "#{Socket.gethostname}"
    fluentd_tag ${tag}
    log_processed_at "#{Time.now.strftime('%Y-%m-%dT%H:%M:%S.%LZ')}"
    environment "#{ENV['ENVIRONMENT'] || 'development'}"
  </record>
</filter>

# -----------------------------
# Route different log types
# -----------------------------

<match go-demo.api.access>
  @type elasticsearch
  host elasticsearch
  port 9200
  scheme http
  logstash_format true
  logstash_prefix go-demo-access
  logstash_dateformat %Y.%m.%d
  include_tag_key true
  tag_key @log_name
  flush_interval 10s

  suppress_type_name true
  default_elasticsearch_version 8
  verify_es_version_at_startup false
  template_overwrite false
  fail_on_putting_template_retry_exceed false
  fail_on_detecting_es_version_retry_exceed false
  request_timeout 120s
  reload_connections false
  reload_on_failure false
  resurrect_after 60s
  log_es_400_reason true

  <buffer>
    @type file
    path /var/log/fluentd/access.buffer
    flush_mode interval
    retry_type exponential_backoff
    flush_thread_count 2
    flush_interval 5s
    retry_forever
    retry_max_interval 30
    chunk_limit_size 2M
    queue_limit_length 8
    overflow_action block
  </buffer>
</match>

<match go-demo.api.detailed>
  @type elasticsearch
  host elasticsearch
  port 9200
  scheme http
  logstash_format true
  logstash_prefix go-demo-detailed
  logstash_dateformat %Y.%m.%d
  include_tag_key true
  tag_key @log_name
  flush_interval 10s

  suppress_type_name true
  default_elasticsearch_version 8
  verify_es_version_at_startup false
  template_overwrite false
  fail_on_putting_template_retry_exceed false
  fail_on_detecting_es_version_retry_exceed false
  request_timeout 120s
  reload_connections false
  reload_on_failure false
  resurrect_after 60s
  log_es_400_reason true

  <buffer>
    @type file
    path /var/log/fluentd/detailed.buffer
    flush_mode interval
    retry_type exponential_backoff
    flush_thread_count 2
    flush_interval 5s
    retry_forever
    retry_max_interval 30
    chunk_limit_size 2M
    queue_limit_length 8
    overflow_action block
  </buffer>
</match>

<match go-demo.api.error>
  @type elasticsearch
  host elasticsearch
  port 9200
  scheme http
  logstash_format true
  logstash_prefix go-demo-errors
  logstash_dateformat %Y.%m.%d
  include_tag_key true
  tag_key @log_name
  flush_interval 5s

  suppress_type_name true
  default_elasticsearch_version 8
  verify_es_version_at_startup false
  template_overwrite false
  fail_on_putting_template_retry_exceed false
  fail_on_detecting_es_version_retry_exceed false
  request_timeout 120s
  reload_connections false
  reload_on_failure false
  resurrect_after 60s
  log_es_400_reason true

  <buffer>
    @type file
    path /var/log/fluentd/error.buffer
    flush_mode interval
    retry_type exponential_backoff
    flush_thread_count 2
    flush_interval 2s
    retry_forever
    retry_max_interval 30
    chunk_limit_size 2M
    queue_limit_length 8
    overflow_action block
  </buffer>
</match>

# Catch-all for other go-demo logs
<match go-demo.**>
  @type elasticsearch
  host elasticsearch
  port 9200
  scheme http
  logstash_format true
  logstash_prefix go-demo-general
  logstash_dateformat %Y.%m.%d
  include_tag_key true
  tag_key @log_name
  flush_interval 10s

  suppress_type_name true
  default_elasticsearch_version 8
  verify_es_version_at_startup false
  template_overwrite false
  fail_on_putting_template_retry_exceed false
  fail_on_detecting_es_version_retry_exceed false
  request_timeout 120s
  reload_connections false
  reload_on_failure false
  resurrect_after 60s
  log_es_400_reason true

  <buffer>
    @type file
    path /var/log/fluentd/general.buffer
    flush_mode interval
    retry_type exponential_backoff
    flush_thread_count 2
    flush_interval 10s
    retry_forever
    retry_max_interval 30
    chunk_limit_size 2M
    queue_limit_length 8
    overflow_action block
  </buffer>
</match>

# Handle FluentD's own logs separately to avoid index creation issues
<match fluent.**>
  @type stdout
  <format>
    @type json
  </format>
</match>

# System logs and other sources (excluding FluentD's own logs)
<match **>
  @type elasticsearch
  host elasticsearch
  port 9200
  scheme http
  logstash_format true
  logstash_prefix fluentd-misc
  logstash_dateformat %Y.%m.%d
  include_tag_key true
  tag_key @log_name
  flush_interval 30s

  suppress_type_name true
  default_elasticsearch_version 8
  verify_es_version_at_startup false
  template_overwrite false
  max_retry_putting_template 10
  fail_on_putting_template_retry_exceed false
  fail_on_detecting_es_version_retry_exceed false
  request_timeout 120s
  reload_connections false
  reload_on_failure false
  resurrect_after 60s
  log_es_400_reason true

  <buffer>
    @type file
    path /var/log/fluentd/misc.buffer
    flush_mode interval
    retry_type exponential_backoff
    flush_thread_count 1
    flush_interval 30s
    retry_forever
    retry_max_interval 30
    chunk_limit_size 2M
    queue_limit_length 8
    overflow_action block
  </buffer>
</match>
